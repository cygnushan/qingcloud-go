// Copyright 2017 <chaishushan{AT}gmail.com>. All rights reserved.
// Use of this source code is governed by a Apache
// license that can be found in the LICENSE file.

syntax = "proto3";

package spec;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

// ----------------------------------------------------------------------------

message ClusterServiceProperties {
	string zone = 1;
}

service ClusterService {
	rpc CreateCluster(CreateClusterInput) returns (CreateClusterOutput);
	rpc DescribeClusters(DescribeClustersInput) returns (DescribeClustersOutput);
	rpc DescribeClusterNodes(DescribeClusterNodesInput) returns (DescribeClusterNodesOutput);
	rpc StopClusters(StopClustersInput) returns (StopClustersOutput);
	rpc StartClusters(StartClustersInput) returns (StartClustersOutput);
	rpc DeleteClusters(DeleteClustersInput) returns (DeleteClustersOutput);
	rpc lease(leaseInput) returns (leaseOutput);
	rpc AddClusterNodes(AddClusterNodesInput) returns (AddClusterNodesOutput);
	rpc DeleteClusterNodes(DeleteClusterNodesInput) returns (DeleteClusterNodesOutput);
	rpc ResizeCluster(ResizeClusterInput) returns (ResizeClusterOutput);
	rpc ChangeClusterVxnet(ChangeClusterVxnetInput) returns (ChangeClusterVxnetOutput);
	rpc SuspendClusters(SuspendClustersInput) returns (SuspendClustersOutput);
	rpc UpdateClusterEnvironment(UpdateClusterEnvironmentInput) returns (UpdateClusterEnvironmentOutput);
	rpc ModifyClusterAttributes(ModifyClusterAttributesInput) returns (ModifyClusterAttributesOutput);
	rpc ModifyClusterNodeAttributes(ModifyClusterNodeAttributesInput) returns (ModifyClusterNodeAttributesOutput);
	rpc GetClustersStats(GetClustersStatsInput) returns (GetClustersStatsOutput);
	rpc DescribeClusterUsers(DescribeClusterUsersInput) returns (DescribeClusterUsersOutput);
	rpc RestartClusterService(RestartClusterServiceInput) returns (RestartClusterServiceOutput);
	rpc UpgradeClusters(UpgradeClustersInput) returns (UpgradeClustersOutput);
	rpc AuthorizeClustersBrokerToDeveloper(AuthorizeClustersBrokerToDeveloperInput) returns (AuthorizeClustersBrokerToDeveloperOutput);
	rpc RevokeClustersBrokerFromDeveloper(RevokeClustersBrokerFromDeveloperInput) returns (RevokeClustersBrokerFromDeveloperOutput);
}

// ----------------------------------------------------------------------------

/*
CreateCluster

conf - 配置文件格式

{
	"app_id": "app-zkv33646",
	"app_version": "1.0",
	"vxnet": "vxnet-p050mao",
	"node": {
		"container": {
		"type": "kvm",
		"image": "img-zookeeper",
		"zone": "allinone"
	},
	"instance_class": 0,
	"count": 3,
	"cpu": 1,
	"memory": 512,
	"volume": {
		"size": 3,
		"mount_point": "/zk_data",
		"filesystem": "xfs",
		"class": 0
	},
	"server_id_upper_bound":255,
	"service": {
		"start": {
			"cmd": "/opt/zookeeper/bin/zkServer.sh start"
		},
		"stop": {
			"cmd": "/opt/zookeeper/bin/zkServer.sh stop"
		}
	}
}
*/

message CreateClusterInput {
	string conf = 1; // 配置信息, JSON 字符串
}
message CreateClusterOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message DescribeClustersInput {
	repeated string clusters = 1;
	string scope = 2;
	string role = 3;
	repeated string app_id = 4;
	repeated string app_version = 5;
	repeated string users = 6;
}

message DescribeClustersOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;

	int32 total_count = 4;
	repeated Cluster cluster_set = 5;

	message Cluster {
		string global_uuid = 1;
		int32 auto_backup_time = 2;
		HealthCheckEnablement health_check_enablement = 3;
		string cfgmgmt_id = 4;
		CustomService custom_service = 5;
		string app_id = 6;
		AdvancedActions advanced_actions = 7;
		string console_id = 8;
		google.protobuf.Timestamp create_time = 9;
		string cluster_id = 10;
		string owner = 11;
		google.protobuf.Timestamp upgrade_time = 12;
		//google.protobuf.Any children = 13;
		bool incremental_backup_supported = 14;
		int32 cluster_type = 15;
		int32 sub_code = 16;
		bool metadata_root_access = 17;
		//google.protobuf.Any add_links = 18;
		string upgrade_status = 19;
		google.protobuf.Timestamp status_time = 20;
		int32 node_count = 21;
		string app_version = 22;
		VxNet vxnet = 23;
		string status = 24;
		string description = 25;
		//google.protobuf.Any parent = 26;
		//repeated google.protobuf.Any tags = 27;
		AppInfo app_info = 28;
		string transition_status = 29;
		bool reuse_hyper = 30;
		string controller = 31;
		//repeated google.protobuf.Any upgrade_policy = 32;
		bool partner_access = 33;
		string name = 34;
		repeated string roles = 35;
		//google.protobuf.Timestamp lastest_snapshot_time = 36;
		string lastest_snapshot_time = 36; // 临时, 目前返回的空字符串是非法格式
		string root_user_id = 37;
		bool debug = 38;
		//repeated google.protobuf.Any backup_policy = 39;
		//repeated google.protobuf.Any endpoints = 40;
		HealthCheckEnablement backup = 41;
		AppVersionInfo app_version_info = 42;

		message HealthCheckEnablement {
			bool ca = 1;
			bool orderer = 2;
			bool peer_node = 3;
		}

		message CustomService {
			//
		}

		message AdvancedActions {
			//google.protobuf.Any ca = 1;
			//google.protobuf.Any orderer = 2;
			//google.protobuf.Any peer_node = 3;
		}

		message VxNet {
			string vxnet_name = 1;
			//int32 vxnet_type = 2; // "vxnet_type":"", 服务器有BUG, 存在返回 空字符串的问题
			string vxnet_id = 3;
			string vpc_router_id = 4;
		}

		message AppInfo {
			string icon = 1;
			string app_id = 2;
			string app_name = 3;
		}

		message AppVersionInfo {
			google.protobuf.Timestamp status_time = 1;
			string resource_kit = 2;
			string name = 3;
			string version_id = 4;
			//repeated google.protobuf.Any upgrade_policy = 5;
		}
	}
}

// ----------------------------------------------------------------------------

message DescribeClusterNodesInput {
	string cluster = 1;
	repeated string cluster_nodes = 2;
	string role = 3;
}
message DescribeClusterNodesOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;

	int32 total_count = 4;
	repeated NodeSet node_set = 5;

	message NodeSet {
		// "passphraseless":null,
		string vertical_scaling_policy = 2;
		string vxnet_id = 3;
		//"destroy_service":null,
		string custom_service = 5;
		string app_id = 6;
		//"advanced_actions":null,
		string console_id = 8;
		string stop_service = 9;
		int32 user_access = 10;
		google.protobuf.Timestamp create_time = 11;
		string cluster_id = 12;
		string private_ip = 13;
		//"upgrade_service":null,
		string owner = 15;
		string alarm_status = 16;
		bool incremental_backup_supported = 17;
		//"restore_service":null,
		int32 server_id = 19;
		string monitor = 20;
		string health_status = 21;
		int32 is_backup = 22;
		string root_user_id = 23;
		string role = 24;
		int32 memory = 25;
		google.protobuf.Timestamp status_time = 26;
		string restart_service = 27;
		string app_version = 28;
		string status = 29;
		int32 global_server_id = 30;
		string scale_in_service = 31;
		int32 auto_backup = 32;
		string transition_status = 33;
		//"custom_metadata":null,
		int32 storage_size = 35;
		//"server_id_upper_bound":null,
		string image_id = 37;
		string controller = 38;
		string node_id = 39;
		bool agent_installed = 40;
		//"reserved_ips":null,
		//"backup_policy":null,
		string start_service = 43;
		string volume_ids = 44;
		string name = 45;
		string hypervisor = 46;
		//"delete_snapshot_service":null,
		string init_service = 48;
		string instance_id = 49;
		string scale_out_service = 50;
		string repl = 51;
		//"custom_metadata_script":null,
		string health_check = 52;
		bool debug = 53;
		string single_node_repl = 54;
		//"pub_key":null,
		int32 group_id = 56;
		//"backup_service":null,
		int32 cpu = 58;
	}
}

// ----------------------------------------------------------------------------

message StopClustersInput {
	repeated string clusters = 1;
	int32 force = 2;
}
message StopClustersOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message StartClustersInput {
	repeated string clusters = 1;
}
message StartClustersOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message DeleteClustersInput {
	repeated string clusters = 1;
}
message DeleteClustersOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message leaseInput {
	repeated string clusters = 1;
}
message leaseOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message AddClusterNodesInput {
	string cluster = 1;
	int32 node_count = 2;
	string node_role = 3;
	string node_name = 4;
	repeated string private_ips = 5;
}
message AddClusterNodesOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message DeleteClusterNodesInput {
	string cluster = 1;
	repeated string nodes = 2;
	int32 force = 3;
}
message DeleteClusterNodesOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message ResizeClusterInput {
	string cluster = 1;
	string node_role = 2;
	int32 cpu = 3;
	int32 memory = 4;
	int32 storage_size = 5;
}
message ResizeClusterOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message ChangeClusterVxnetInput {
	string cluster = 1;
	string vxnet = 2;
	map<string, string> private_ips = 3;
	repeated string roles = 4;
}
message ChangeClusterVxnetOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message SuspendClustersInput {
	repeated string clusters = 1;
}
message SuspendClustersOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message UpdateClusterEnvironmentInput {
	string cluster = 1;
	repeated string roles = 2;
	map<string, string> env = 3;
}
message UpdateClusterEnvironmentOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message ModifyClusterAttributesInput {
	string cluster = 1;
	string name = 2;
	string description = 3;
}
message ModifyClusterAttributesOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message ModifyClusterNodeAttributesInput {
	string cluster = 1;
	string cluster_node = 2;
	string name = 3;
}
message ModifyClusterNodeAttributesOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message GetClustersStatsInput {
	repeated string zones = 1;
}
message GetClustersStatsOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message DescribeClusterUsersInput {
	repeated string zones = 1;
	repeated string apps = 2;
	repeated string app_versions = 3;
	repeated string users = 4;
	repeated string cluster_status = 5;
}
message DescribeClusterUsersOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message RestartClusterServiceInput {
	string cluster = 1;
	string role = 2;
}
message RestartClusterServiceOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message UpgradeClustersInput {
	repeated string clusters = 1;
	string app_version = 2;
}
message UpgradeClustersOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message AuthorizeClustersBrokerToDeveloperInput {
	repeated string clusters = 1;
}
message AuthorizeClustersBrokerToDeveloperOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------

message RevokeClustersBrokerFromDeveloperInput {
	repeated string clusters = 1;
}
message RevokeClustersBrokerFromDeveloperOutput {
	string action = 1;
	int32 ret_code = 2;
	string message = 3;
}

// ----------------------------------------------------------------------------
// END
// ----------------------------------------------------------------------------
